/*
 (c)2015, Smart Origin SARL
 @license
 Copyright (c) 2015 Smart Origin SARL

 Redistribution and use in source and binary forms, with or without modification, are
 permitted provided that the following conditions are met:

  1. Redistributions of source code must retain the above copyright notice, this list of
  conditions and the following disclaimer.

  2. Redistributions in binary form must reproduce the above copyright notice, this list
  of conditions and the following disclaimer in the documentation and/or other materials
  provided with the distribution.

 THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
 EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
 MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
 COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
 TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/
(function(F,J){"function"===typeof define&&define.amd?define(J):F.OSMBuildings=J(F)})(this,function(F){function J(a,b){var c=a.x-b.x,d=a.y-b.y;return c*c+d*d}function qa(a){var b=a.length;if(16>b)return!1;var c,d=Infinity,e=-Infinity,f=Infinity,h=-Infinity;for(c=0;c<b-1;c+=2)d=Math.min(d,a[c]),e=Math.max(e,a[c]),f=Math.min(f,a[c+1]),h=Math.max(h,a[c+1]);c=e-d;h-=f;e=c/h;if(.85>e||1.15<e)return!1;d={x:d+c/2,y:f+h/2};c=(c+h)/4;f=c*c;for(c=0;c<b-1;c+=2)if(h=J({x:a[c],y:a[c+1]},d),.8>h/f||1.2<h/f)return!1;
return!0}function fa(a,b){var c={};a/=L;b/=L;var d;d=0>=b?90:1<=b?-90:(2*ra(sa(C*(1-2*b)))-M)/C*180;c.latitude=d;c.longitude=360*(1===a?1:(a%1+1)%1)-180;return c}function V(a,b){var c=W(1,I(0,.5-ta(ka(ua+M*a/180))/C/2));return{x:(b/360+.5)*L<<0,y:c*L<<0}}function X(a){for(var b=A+p,c=z+q,d=0,e=a.length-3;d<e;d+=2)if(a[d]>p&&a[d]<b&&a[d+1]>q&&a[d+1]<c)return!0;return!1}function va(){aa||(aa=setInterval(function(){for(var a=D.items,b=!1,c=0,d=a.length;c<d;c++)1>a[c].scale&&(a[c].scale+=.1,1<a[c].scale&&
(a[c].scale=1),b=!0);E.render();b||(clearInterval(aa),aa=null)},33))}var m=Math,sa=m.exp,ta=m.log,wa=m.sin,xa=m.cos,ka=m.tan,ra=m.atan,N=m.atan2,W=m.min,I=m.max,la=m.sqrt,ma=m.ceil,ga=m.pow,na=na||Array,oa=oa||Array,m=/iP(ad|hone|od)/g.test(navigator.userAgent),ya=!!~navigator.userAgent.indexOf("Trident"),za=!F.requestAnimationFrame||m||ya?function(a){a()}:F.requestAnimationFrame,B=function(a){function b(b,a,c){0>c&&(c+=1);1<c&&--c;return c<1/6?b+6*(a-b)*c:.5>c?a:c<2/3?b+(a-b)*(2/3-c)*6:b}function c(b,
a){return Math.min(a,Math.max(0,b||0))}var d={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",
darkgray:"#a9a9a9",darkgrey:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",
fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgrey:"#d3d3d3",lightgreen:"#90ee90",
lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",
mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",
salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};a=function(b){b=b||"";if("object"===typeof b)this.R=c(b.r,I),this.G=
c(b.g,I),this.B=c(b.b,I),this.A=void 0!==b.a?c(b.a,1):1,this.isValid=!0;else if("string"===typeof b){b=b.toLowerCase();b=d[b]||b;var a;if(a=b.match(/^#?(\w{2})(\w{2})(\w{2})$/))this.R=parseInt(a[1],16)/255,this.G=parseInt(a[2],16)/255,this.B=parseInt(a[3],16)/255,this.A=1,this.isValid=!0;else if(a=b.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))this.R=parseInt(a[1],10)/255,this.G=parseInt(a[2],10)/255,this.B=parseInt(a[3],10)/255,this.A=a[4]?parseFloat(a[5]):1,this.isValid=!0}};a.prototype=
{toHSL:function(){var b=Math.max(this.R,this.G,this.B),a=Math.min(this.R,this.G,this.B),c,d=(b+a)/2,g=b-a;if(g){a=.5<d?g/(2-b-a):g/(b+a);switch(b){case this.R:c=(this.G-this.B)/g+(this.G<this.B?6:0);break;case this.G:c=(this.B-this.R)/g+2;break;case this.B:c=(this.R-this.G)/g+4}c*=60}else c=a=0;return{h:c,s:a,l:d}},fromHSL:function(a){if(0===a.s)this.B=this.G=this.R=a.l;else{var c=.5>a.l?a.l*(1+a.s):a.l+a.s-a.l*a.s,d=2*a.l-c;a.h/=360;this.R=b(d,c,a.h+1/3);this.G=b(d,c,a.h);this.B=b(d,c,a.h-1/3)}return this},
toString:function(){return 1===this.A?"#"+(16777216+(Math.round(255*this.R)<<16)+(Math.round(255*this.G)<<8)+Math.round(255*this.B)).toString(16).slice(1,7):"rgba("+[Math.round(255*this.R),Math.round(255*this.G),Math.round(255*this.B),this.A.toFixed(2)].join()+")"},toArray:function(){return[this.R,this.G,this.B]},hue:function(b){var a=this.toHSL();a.h*=b;this.fromHSL(a);return this},saturation:function(b){var a=this.toHSL();a.s*=b;this.fromHSL(a);return this},lightness:function(b){var a=this.toHSL();
a.l*=b;this.fromHSL(a);return this},alpha:function(b){this.A*=b;return this}};return a}(this),Aa=function(){var a=Math,b=a.PI,c=a.sin,d=a.cos,e=a.tan,f=a.asin,h=a.atan2,k=b/180,g=23.4397*k;return function(a,n,r){r=k*-r;n*=k;a=a.valueOf()/864E5-.5+2440588-2451545;var t=k*(357.5291+.98560028*a),m;m=k*(1.9148*c(t)+.02*c(2*t)+3E-4*c(3*t));m=t+m+102.9372*k+b;t=f(c(0)*d(g)+d(0)*c(g)*c(m));m=h(c(m)*d(g)-e(0)*c(g),d(m));a=k*(280.16+360.9856235*a)-r-m;r=f(c(n)*c(t)+d(n)*d(t)*d(a));n=h(c(a),d(a)*c(n)-e(t)*
d(n));return{altitude:r,azimuth:n-b/2}}}(),Ca=function(){function a(a){a=a.toLowerCase();return"#"===a[0]?a:d[e[a]||a]||null}function b(a,b){var c,d,e,n,r=0,t,m;t=0;for(m=a.length-3;t<m;t+=2)c=a[t],d=a[t+1],e=a[t+2],n=a[t+3],r+=c*n-e*d;if((0<r/2?"CW":"CCW")===b)return a;c=[];for(d=a.length-2;0<=d;d-=2)c.push(a[d],a[d+1]);return c}function c(a){var d,e,g=[],l;switch(a.type){case "GeometryCollection":g=[];d=0;for(e=a.geometries.length;d<e;d++)(l=c(a.geometries[d]))&&g.push.apply(g,l);return g;case "MultiPolygon":g=
[];d=0;for(e=a.coordinates.length;d<e;d++)(l=c({type:"Polygon",coordinates:a.coordinates[d]}))&&g.push.apply(g,l);return g;case "Polygon":a=a.coordinates;break;default:return[]}var n,r=[],t=[];n=a[0];d=0;for(e=n.length;d<e;d++)r.push(n[d][1],n[d][0]);r=b(r,"CW");d=0;for(e=a.length-1;d<e;d++){n=a[d+1];t[d]=[];g=0;for(l=n.length;g<l;g++)t[d].push(n[g][1],n[g][0]);t[d]=b(t[d],"CCW")}return[{outer:r,inner:t.length?t:null}]}var d={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",
glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},e={asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",
shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"};return{read:function(b){if(!b||"FeatureCollection"!==b.type)return[];b=b.features;var d,e,g,l,n=[],r,t,m,p;d=0;for(e=b.length;d<e;d++)if(r=b[d],"Feature"===r.type&&!1!==pa(r)){g=r.properties;l={};g=g||{};l.height=g.height||(g.levels?3*g.levels:Ba);l.minHeight=g.minHeight||(g.minLevel?3*g.minLevel:0);if(t=g.material?a(g.material):g.wallColor||g.color)l.wallColor=
t;if(t=g.roofMaterial?a(g.roofMaterial):g.roofColor)l.roofColor=t;switch(g.shape){case "cylinder":case "cone":case "dome":case "sphere":l.shape=g.shape;l.isRotational=!0;break;case "pyramid":l.shape=g.shape}switch(g.roofShape){case "cone":case "dome":l.roofShape=g.roofShape;l.isRotational=!0;break;case "pyramid":l.roofShape=g.roofShape}l.roofShape&&g.roofHeight?(l.roofHeight=g.roofHeight,l.height=I(0,l.height-l.roofHeight)):l.roofHeight=0;m=l;t=c(r.geometry);g=0;for(l=t.length;g<l;g++){p=m;var q=
{},v=void 0;for(v in p)p.hasOwnProperty(v)&&(q[v]=p[v]);p=q;p.footprint=t[g].outer;if(p.isRotational){for(var q=p,v=p.footprint,x=180,w=-180,u=0,y=v.length;u<y;u+=2)x=W(x,v[u+1]),w=I(w,v[u+1]);q.radius=(w-x)/2}t[g].inner&&(p.holes=t[g].inner);if(r.id||r.properties.id)p.id=r.id||r.properties.id;r.properties.relationId&&(p.relationId=r.properties.relationId);n.push(p)}}return n}}}(),C=Math.PI,M=C/2,ua=C/4,ba=256,w,L,G=15,A=0,z=0,O=0,ca=0,p=0,q=0,H=new B("rgba(200, 190, 180)"),P=H.lightness(.8),K=H.lightness(1.2),
da=""+H,Y=""+P,Q=""+K,ha=0,u=1,ia,Ba=5,R,S,T,Da=function(){function a(a,f){if(b[a])f&&f(b[a]);else{var h=new XMLHttpRequest;h.onreadystatechange=function(){if(4===h.readyState&&!(!h.status||200>h.status||299<h.status)&&f&&h.responseText){var k=h.responseText;b[a]=k;c.push({url:a,size:k.length});d+=k.length;for(f(k);5242880<d;)k=c.shift(),d-=k.size,delete b[k.url]}};h.open("GET",a);h.send(null);return h}}var b={},c=[],d=0;return{loadJSON:function(b,c){return a(b,function(a){var b;try{b=JSON.parse(a)}catch(d){}c(b)})}}}(),
D={loadedItems:{},items:[],getPixelFootprint:function(a){for(var b=new na(a.length),c,d=0,e=a.length-1;d<e;d+=2)c=V(a[d],a[d+1]),b[d]=c.x,b[d+1]=c.y;a=b;b=a.length/2;c=new oa(b);var d=0,e=b-1,f,h,k,g,l=[],n=[],r=[];for(c[d]=c[e]=1;e;){h=0;for(f=d+1;f<e;f++){k=a[2*f];var m=a[2*f+1],p=a[2*d],q=a[2*d+1],v=a[2*e],x=a[2*e+1],u=v-p,w=x-q,y=void 0;if(0!==u||0!==w)y=((k-p)*u+(m-q)*w)/(u*u+w*w),1<y?(p=v,q=x):0<y&&(p+=u*y,q+=w*y);u=k-p;w=m-q;k=u*u+w*w;k>h&&(g=f,h=k)}2<h&&(c[g]=1,l.push(d),n.push(g),l.push(g),
n.push(e));d=l.pop();e=n.pop()}for(f=0;f<b;f++)c[f]&&r.push(a[2*f],a[2*f+1]);b=r;if(!(8>b.length))return b},resetItems:function(){this.items=[];this.loadedItems={};ea.reset()},addRenderItems:function(a,b){for(var c,d,e,f=Ca.read(a),h=0,k=f.length;h<k;h++)c=f[h],e=c.id||[c.footprint[0],c.footprint[1],c.height,c.minHeight].join(),!this.loadedItems[e]&&(d=this.scale(c))&&(d.scale=b?0:1,this.items.push(d),this.loadedItems[e]=1);va()},scale:function(a){var b={},c=6/ga(2,w-G);a.id&&(b.id=a.id);b.height=
W(a.height/c,ia);b.minHeight=isNaN(a.minHeight)?0:a.minHeight/c;if(!(b.minHeight>ia)&&(b.footprint=this.getPixelFootprint(a.footprint),b.footprint)){for(var d=b.footprint,e=Infinity,f=-Infinity,h=Infinity,k=-Infinity,g=0,l=d.length-3;g<l;g+=2)e=W(e,d[g]),f=I(f,d[g]),h=W(h,d[g+1]),k=I(k,d[g+1]);b.center={x:e+(f-e)/2<<0,y:h+(k-h)/2<<0};a.radius&&(b.radius=a.radius*ha);a.shape&&(b.shape=a.shape);a.roofShape&&(b.roofShape=a.roofShape);"cone"!==b.roofShape&&"dome"!==b.roofShape||b.shape||!qa(b.footprint)||
(b.shape="cylinder");if(a.holes){b.holes=[];for(var n,d=0,e=a.holes.length;d<e;d++)(n=this.getPixelFootprint(a.holes[d]))&&b.holes.push(n)}var r;a.wallColor&&(r=new B(a.wallColor))&&(r=r.alpha(u),b.altColor=""+r.lightness(.8),b.wallColor=""+r);a.roofColor&&(r=new B(a.roofColor))&&(b.roofColor=""+r.alpha(u));a.relationId&&(b.relationId=a.relationId);b.hitColor=ea.idToColor(a.relationId||a.id);b.roofHeight=isNaN(a.roofHeight)?0:a.roofHeight/c;if(!(b.height+b.roofHeight<=b.minHeight))return b}},set:function(a){this.isStatic=
!0;this.resetItems();this._staticData=a;this.addRenderItems(this._staticData,!0)},load:function(a,b){this.src=a||"http://{s}.data.osmbuildings.org/0.2/{k}/tile/{z}/{x}/{y}.json".replace("{k}",b||"anonymous");this.update()},update:function(){function a(a){h.addRenderItems(a)}this.resetItems();if(!(w<G))if(this.isStatic&&this._staticData)this.addRenderItems(this._staticData);else if(this.src){var b=ba,c=16<w?b<<w-16:b>>16-w,b=p/c<<0,d=q/c<<0,e=ma((p+A)/c),c=ma((q+z)/c),f,h=this;for(f=d;f<=c;f++)for(d=
b;d<=e;d++)this.loadTile(d,f,16,a)}},loadTile:function(a,b,c,d){a=this.src.replace("{s}","abcd"[(a+b)%4]).replace("{x}",a).replace("{y}",b).replace("{z}",c);return Da.loadJSON(a,d)}},Z={draw:function(a,b,c,d,e,f,h,k){var g,l=this._extrude(a,b,d,e,f,h),n=[];if(c)for(b=0,g=c.length;b<g;b++)n[b]=this._extrude(a,c[b],d,e,f,h);a.fillStyle=k;a.beginPath();this._ring(a,l);if(c)for(b=0,g=n.length;b<g;b++)this._ring(a,n[b]);a.closePath();a.stroke();a.fill()},_extrude:function(a,b,c,d,e,f){c=450/(450-c);for(var h=
450/(450-d),k={x:0,y:0},g={x:0,y:0},l,n,r=[],m=0,u=b.length-3;m<u;m+=2)k.x=b[m]-p,k.y=b[m+1]-q,g.x=b[m+2]-p,g.y=b[m+3]-q,l=v.project(k,c),n=v.project(g,c),d&&(k=v.project(k,h),g=v.project(g,h)),(g.x-k.x)*(l.y-k.y)>(l.x-k.x)*(g.y-k.y)&&(a.fillStyle=k.x<g.x&&k.y<g.y||k.x>g.x&&k.y>g.y?f:e,a.beginPath(),this._ring(a,[g.x,g.y,k.x,k.y,l.x,l.y,n.x,n.y]),a.closePath(),a.fill()),r[m]=l.x,r[m+1]=l.y;return r},_ring:function(a,b){a.moveTo(b[0],b[1]);for(var c=2,d=b.length-1;c<d;c+=2)a.lineTo(b[c],b[c+1])},simplified:function(a,
b,c){a.beginPath();this._ringAbs(a,b);if(c){b=0;for(var d=c.length;b<d;b++)this._ringAbs(a,c[b])}a.closePath();a.stroke();a.fill()},_ringAbs:function(a,b){a.moveTo(b[0]-p,b[1]-q);for(var c=2,d=b.length-1;c<d;c+=2)a.lineTo(b[c]-p,b[c+1]-q)},shadow:function(a,b,c,d,e){for(var f=null,h={x:0,y:0},k={x:0,y:0},g,l,n=0,m=b.length-3;n<m;n+=2)h.x=b[n]-p,h.y=b[n+1]-q,k.x=b[n+2]-p,k.y=b[n+3]-q,g=y.project(h,d),l=y.project(k,d),e&&(h=y.project(h,e),k=y.project(k,e)),(k.x-h.x)*(g.y-h.y)>(g.x-h.x)*(k.y-h.y)?(1===
f&&a.lineTo(h.x,h.y),f=0,n||a.moveTo(h.x,h.y),a.lineTo(k.x,k.y)):(0===f&&a.lineTo(g.x,g.y),f=1,n||a.moveTo(g.x,g.y),a.lineTo(l.x,l.y));if(c)for(n=0,m=c.length;n<m;n++)this._ringAbs(a,c[n])},shadowMask:function(a,b,c){this._ringAbs(a,b);if(c){b=0;for(var d=c.length;b<d;b++)this._ringAbs(a,c[b])}},hitArea:function(a,b,c,d,e,f){c=null;var h={x:0,y:0},k={x:0,y:0};d=450/(450-d);var g=450/(450-e),l;a.fillStyle=f;a.beginPath();for(var n=0,m=b.length-3;n<m;n+=2)h.x=b[n]-p,h.y=b[n+1]-q,k.x=b[n+2]-p,k.y=b[n+
3]-q,f=v.project(h,d),l=v.project(k,d),e&&(h=v.project(h,g),k=v.project(k,g)),(k.x-h.x)*(f.y-h.y)>(f.x-h.x)*(k.y-h.y)?(1===c&&a.lineTo(h.x,h.y),c=0,n||a.moveTo(h.x,h.y),a.lineTo(k.x,k.y)):(0===c&&a.lineTo(f.x,f.y),c=1,n||a.moveTo(f.x,f.y),a.lineTo(l.x,l.y));a.closePath();a.fill()}},x={draw:function(a,b,c,d,e,f,h,k,g){b={x:b.x-p,y:b.y-q};var l=450/(450-e),n=450/(450-f);e=v.project(b,l);d*=l;f&&(b=v.project(b,n),c*=n);(l=this._tangents(b,c,e,d))?(f=N(l[0].y1-b.y,l[0].x1-b.x),l=N(l[1].y1-b.y,l[1].x1-
b.x)):(f=1.5*C,l=1.5*C);a.fillStyle=h;a.beginPath();a.arc(e.x,e.y,d,M,f,!0);a.arc(b.x,b.y,c,f,M);a.closePath();a.fill();a.fillStyle=k;a.beginPath();a.arc(e.x,e.y,d,l,M,!0);a.arc(b.x,b.y,c,M,l);a.closePath();a.fill();a.fillStyle=g;this._circle(a,e,d)},simplified:function(a,b,c){this._circle(a,{x:b.x-p,y:b.y-q},c)},shadow:function(a,b,c,d,e,f){b={x:b.x-p,y:b.y-q};e=y.project(b,e);var h;f&&(b=y.project(b,f));var k=this._tangents(b,c,e,d);k?(f=N(k[0].y1-b.y,k[0].x1-b.x),h=N(k[1].y1-b.y,k[1].x1-b.x),a.moveTo(k[1].x2,
k[1].y2),a.arc(e.x,e.y,d,h,f),a.arc(b.x,b.y,c,f,h)):(a.moveTo(b.x+c,b.y),a.arc(b.x,b.y,c,0,2*C))},shadowMask:function(a,b,c){var d=b.x-p;b=b.y-q;a.moveTo(d+c,b);a.arc(d,b,c,0,2*C)},hitArea:function(a,b,c,d,e,f,h){b={x:b.x-p,y:b.y-q};var k=450/(450-e),g=450/(450-f);e=v.project(b,k);d*=k;f&&(b=v.project(b,g),c*=g);f=this._tangents(b,c,e,d);a.fillStyle=h;a.beginPath();f?(h=N(f[0].y1-b.y,f[0].x1-b.x),k=N(f[1].y1-b.y,f[1].x1-b.x),a.moveTo(f[1].x2,f[1].y2),a.arc(e.x,e.y,d,k,h),a.arc(b.x,b.y,c,h,k)):(a.moveTo(b.x+
c,b.y),a.arc(b.x,b.y,c,0,2*C));a.closePath();a.fill()},_circle:function(a,b,c){a.beginPath();a.arc(b.x,b.y,c,0,2*C);a.stroke();a.fill()},_tangents:function(a,b,c,d){var e=a.x-c.x,f=a.y-c.y,h=b-d,k=e*e+f*f;if(!(k<=h*h)){var k=la(k),e=-e/k,f=-f/k,h=h/k,k=[],g,l,n;g=la(I(0,1-h*h));for(var m=1;-1<=m;m-=2)l=e*h-m*g*f,n=f*h+m*g*e,k.push({x1:a.x+b*l<<0,y1:a.y+b*n<<0,x2:c.x+d*l<<0,y2:c.y+d*n<<0});return k}}},U={draw:function(a,b,c,d,e,f,h){var k=450/(450-e);c=v.project({x:c.x-p,y:c.y-q},450/(450-d));d={x:0,
y:0};for(var g={x:0,y:0},l=0,n=b.length-3;l<n;l+=2)d.x=b[l]-p,d.y=b[l+1]-q,g.x=b[l+2]-p,g.y=b[l+3]-q,e&&(d=v.project(d,k),g=v.project(g,k)),(g.x-d.x)*(c.y-d.y)>(c.x-d.x)*(g.y-d.y)&&(a.fillStyle=d.x<g.x&&d.y<g.y||d.x>g.x&&d.y>g.y?h:f,a.beginPath(),this._triangle(a,d,g,c),a.closePath(),a.fill())},_triangle:function(a,b,c,d){a.moveTo(b.x,b.y);a.lineTo(c.x,c.y);a.lineTo(d.x,d.y)},_ring:function(a,b){a.moveTo(b[0]-p,b[1]-q);for(var c=2,d=b.length-1;c<d;c+=2)a.lineTo(b[c]-p,b[c+1]-q)},shadow:function(a,
b,c,d,e){var f={x:0,y:0},h={x:0,y:0};c=y.project({x:c.x-p,y:c.y-q},d);d=0;for(var k=b.length-3;d<k;d+=2)f.x=b[d]-p,f.y=b[d+1]-q,h.x=b[d+2]-p,h.y=b[d+3]-q,e&&(f=y.project(f,e),h=y.project(h,e)),(h.x-f.x)*(c.y-f.y)>(c.x-f.x)*(h.y-f.y)&&this._triangle(a,f,h,c)},shadowMask:function(a,b){this._ring(a,b)},hitArea:function(a,b,c,d,e,f){var h=450/(450-e);c=v.project({x:c.x-p,y:c.y-q},450/(450-d));d={x:0,y:0};var k={x:0,y:0};a.fillStyle=f;a.beginPath();f=0;for(var g=b.length-3;f<g;f+=2)d.x=b[f]-p,d.y=b[f+
1]-q,k.x=b[f+2]-p,k.y=b[f+3]-q,e&&(d=v.project(d,h),k=v.project(k,h)),(k.x-d.x)*(c.y-d.y)>(c.x-d.x)*(k.y-d.y)&&this._triangle(a,d,k,c);a.closePath();a.fill()}},v={project:function(a,b){return{x:(a.x-R)*b+R<<0,y:(a.y-S)*b+S<<0}},render:function(){var a=this.context;a.clearRect(0,0,A,z);if(!(w<G||T)){var b,c,d,e={x:R+p,y:S+q},f,h,k,g,l=D.items;l.sort(function(a,b){return a.minHeight-b.minHeight||J(b.center,e)-J(a.center,e)||b.height-a.height});for(var n=0,m=l.length;n<m;n++)if(b=l[n],!ja.isSimple(b)&&
(f=b.footprint,X(f))){c=1>b.scale?b.height*b.scale:b.height;d=0;b.minHeight&&(d=1>b.scale?b.minHeight*b.scale:b.minHeight);h=b.wallColor||da;k=b.altColor||Y;g=b.roofColor||Q;a.strokeStyle=k;switch(b.shape){case "cylinder":x.draw(a,b.center,b.radius,b.radius,c,d,h,k,g);break;case "cone":x.draw(a,b.center,b.radius,0,c,d,h,k);break;case "dome":x.draw(a,b.center,b.radius,b.radius/2,c,d,h,k);break;case "sphere":x.draw(a,b.center,b.radius,b.radius,c,d,h,k,g);break;case "pyramid":U.draw(a,f,b.center,c,d,
h,k);break;default:Z.draw(a,f,b.holes,c,d,h,k,g)}switch(b.roofShape){case "cone":x.draw(a,b.center,b.radius,0,c+b.roofHeight,c,g,""+(new B(g)).lightness(.9));break;case "dome":x.draw(a,b.center,b.radius,b.radius/2,c+b.roofHeight,c,g,""+(new B(g)).lightness(.9));break;case "pyramid":U.draw(a,f,b.center,c+b.roofHeight,c,g,(new B(g)).lightness(.9))}}}}},ja={maxZoom:G+2,maxHeight:5,isSimple:function(a){return w<=this.maxZoom&&a.height+a.roofHeight<this.maxHeight},render:function(){var a=this.context;
a.clearRect(0,0,A,z);if(!(w<G||T||w>this.maxZoom))for(var b,c,d=D.items,e=0,f=d.length;e<f;e++)if(b=d[e],!(b.height>=this.maxHeight)&&(c=b.footprint,X(c)))switch(a.strokeStyle=b.altColor||Y,a.fillStyle=b.roofColor||Q,b.shape){case "cylinder":case "cone":case "dome":case "sphere":x.simplified(a,b.center,b.radius);break;default:Z.simplified(a,c,b.holes)}}},y={enabled:!0,color:"#666666",blurColor:"#000000",blurSize:15,date:new Date,direction:{x:0,y:0},project:function(a,b){return{x:a.x+this.direction.x*
b,y:a.y+this.direction.y*b}},render:function(){var a=this.context,b,c,d;a.clearRect(0,0,A,z);if(!(!this.enabled||w<G||T||(b=fa(O+p,ca+q),b=Aa(this.date,b.latitude,b.longitude),0>=b.altitude))){c=1/ka(b.altitude);d=5>c?.75:1/c*5;this.direction.x=xa(b.azimuth)*c;this.direction.y=wa(b.azimuth)*c;var e,f,h,k;b=D.items;a.canvas.style.opacity=d/(2*u);a.shadowColor=this.blurColor;a.shadowBlur=u/2*this.blurSize;a.fillStyle=this.color;a.beginPath();d=0;for(c=b.length;d<c;d++)if(e=b[d],k=e.footprint,X(k)){f=
1>e.scale?e.height*e.scale:e.height;h=0;e.minHeight&&(h=1>e.scale?e.minHeight*e.scale:e.minHeight);switch(e.shape){case "cylinder":x.shadow(a,e.center,e.radius,e.radius,f,h);break;case "cone":x.shadow(a,e.center,e.radius,0,f,h);break;case "dome":x.shadow(a,e.center,e.radius,e.radius/2,f,h);break;case "sphere":x.shadow(a,e.center,e.radius,e.radius,f,h);break;case "pyramid":U.shadow(a,k,e.center,f,h);break;default:Z.shadow(a,k,e.holes,f,h)}switch(e.roofShape){case "cone":x.shadow(a,e.center,e.radius,
0,f+e.roofHeight,f);break;case "dome":x.shadow(a,e.center,e.radius,e.radius/2,f+e.roofHeight,f);break;case "pyramid":U.shadow(a,k,e.center,f+e.roofHeight,f)}}a.closePath();a.fill();a.shadowBlur=null;a.globalCompositeOperation="destination-out";a.beginPath();d=0;for(c=b.length;d<c;d++)if(e=b[d],k=e.footprint,X(k)&&!e.minHeight)switch(e.shape){case "cylinder":case "cone":case "dome":x.shadowMask(a,e.center,e.radius);break;default:Z.shadowMask(a,k,e.holes)}a.fillStyle="#00ff00";a.fill();a.globalCompositeOperation=
"source-over"}}},ea={_idMapping:[null],reset:function(){this._idMapping=[null]},render:function(){if(!this._timer){var a=this;this._timer=setTimeout(function(){a._timer=null;a._render()},500)}},_render:function(){var a=this.context;a.clearRect(0,0,A,z);if(!(w<G||T)){var b,c,d,e={x:R+p,y:S+q},f,h,k=D.items;k.sort(function(a,b){return a.minHeight-b.minHeight||J(b.center,e)-J(a.center,e)||b.height-a.height});for(var g=0,l=k.length;g<l;g++)if(b=k[g],h=b.hitColor)if(f=b.footprint,X(f)){c=b.height;d=0;
b.minHeight&&(d=b.minHeight);switch(b.shape){case "cylinder":x.hitArea(a,b.center,b.radius,b.radius,c,d,h);break;case "cone":x.hitArea(a,b.center,b.radius,0,c,d,h);break;case "dome":x.hitArea(a,b.center,b.radius,b.radius/2,c,d,h);break;case "sphere":x.hitArea(a,b.center,b.radius,b.radius,c,d,h);break;case "pyramid":U.hitArea(a,f,b.center,c,d,h);break;default:Z.hitArea(a,f,b.holes,c,d,h)}switch(b.roofShape){case "cone":x.hitArea(a,b.center,b.radius,0,c+b.roofHeight,c,h);break;case "dome":x.hitArea(a,
b.center,b.radius,b.radius/2,c+b.roofHeight,c,h);break;case "pyramid":U.hitArea(a,f,b.center,c+b.roofHeight,c,h)}}A&&z&&(this._imageData=this.context.getImageData(0,0,A,z).data)}},getIdFromXY:function(a,b){var c=this._imageData;if(c){var d=4*((b|0)*A+(a|0));return this._idMapping[c[d]|c[d+1]<<8|c[d+2]<<16]}},idToColor:function(a){var b=this._idMapping.indexOf(a);-1===b&&(this._idMapping.push(a),b=this._idMapping.length-1);return"rgb("+[b&255,b>>8&255,b>>16&255].join()+")"}},aa,E={container:document.createElement("DIV"),
items:[],init:function(){this.container.style.pointerEvents="none";this.container.style.position="absolute";this.container.style.left=0;this.container.style.top=0;y.context=this.createContext(this.container);ja.context=this.createContext(this.container);v.context=this.createContext(this.container);ea.context=this.createContext()},render:function(a){za(function(){a||(y.render(),ja.render(),ea.render());v.render()})},createContext:function(a){var b=document.createElement("CANVAS");b.style.transform=
"translate3d(0, 0, 0)";b.style.imageRendering="optimizeSpeed";b.style.position="absolute";b.style.left=0;b.style.top=0;var c=b.getContext("2d");c.lineCap="round";c.lineJoin="round";c.lineWidth=1;c.imageSmoothingEnabled=!1;this.items.push(b);a&&a.appendChild(b);return c},appendTo:function(a){a.appendChild(this.container)},remove:function(){this.container.parentNode.removeChild(this.container)},setSize:function(a,b){for(var c=0,d=this.items.length;c<d;c++)this.items[c].width=a,this.items[c].height=
b},setPosition:function(a,b){this.container.style.left=a+"px";this.container.style.top=b+"px"}};E.init();F=function(){};m=F.prototype={};m.setMinZoom=function(a){G=a};m.getAttribution=function(){return'&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'};m.appendTo=function(a){E.appendTo(a);return E.container};m.moveCam=function(a){R=O+a.x;S=z+a.y;E.render(!0)};m.setTileSize=function(a){ba=a};m.setOrigin=function(a){p=a.x;q=a.y};m.setSize=function(a){A=a.width;z=a.height;O=A/2<<0;ca=z/2<<
0;R=O;S=z;E.setSize(A,z);ia=400};m.setZoom=function(a){w=a;L=ba<<w;a=fa(p+O,q+ca);var b=V(a.latitude,0);ha=V(a.latitude,1).x-b.x;u=ga(.95,w-G);da=""+H.alpha(u);Y=""+P.alpha(u);Q=""+K.alpha(u)};m.render=function(){E.render()};m.onZoomEnd=function(a){T=!1;w=a.zoom;L=ba<<w;a=fa(p+O,q+ca);var b=V(a.latitude,0);ha=V(a.latitude,1).x-b.x;u=ga(.95,w-G);da=""+H.alpha(u);Y=""+P.alpha(u);Q=""+K.alpha(u);D.update();E.render()};m.onZoomStart=function(){T=!0;E.render()};m.onMoveEnd=function(a){E.render();D.update()};
m.addRenderItems=function(a,b){return D.addRenderItems(a,b)};m.clear=function(){return D.addRenderItems({features:[]})};m.setStyle=function(a,b,c,d,e){y.color=d;y.blurColor=e;H=new B(a);P=new B(b);K=new B(c)};B.prototype.alpha=function(a){this.A=a;return this};m.style=function(a){a=a||{};var b;if(b=a.color||a.wallColor)H=new B(b),da=""+H.alpha(u),P=H.lightness(.8),Y=""+P.alpha(u),K=H.lightness(1.2),Q=""+K.alpha(u);a.roofColor&&(K=new B(a.roofColor),Q=""+K.alpha(u));void 0!==a.shadows&&(y.enabled=
!!a.shadows);E.render();return this};m.date=function(a){y.date=a;y.render();return this};m.load=function(a){D.load(a);return this};m.set=function(a){D.set(a);return this};var pa=function(){};m.each=function(a){pa=function(b){return a(b)};return this};m.click=function(a){return this};F.VERSION="0.2.3b";F.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>';return F});
